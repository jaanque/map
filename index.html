<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Sicilia - Erasmus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html, body { margin: 0; height: 100%; }
    #map { width: 100%; height: 100vh; }



    #formulario {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      padding: 16px;
      border-radius: 14px;
      width: 300px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
      z-index: 1000;
      animation: abrirFormulario 0.4s ease-out;
    }

    @keyframes abrirFormulario {
      0% { opacity: 0; transform: scale(0.7); }
      100% { opacity: 1; transform: scale(1); }
    }

    #centrar-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 999;
      background: white;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    #centrar-btn:hover {
      transform: scale(1.1);
    }

    #zoom-info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9em;
      color: #666;
      z-index: 999;
      border: 1px solid #ddd;
    }

    /* Estilos para popup personalizados */
    .popup-content {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.4;
      color: #333;
      max-width: 260px;
    }
    .popup-title {
      font-weight: 700;
      font-size: 1.2em;
      margin-bottom: 4px;
      color: #007bff;
    }
    .popup-category {
      font-weight: 600;
      font-size: 0.95em;
      color: #555;
      margin-bottom: 6px;
      text-transform: capitalize;
    }
    .popup-field {
      margin-bottom: 6px;
    }
    .popup-label {
      font-weight: 600;
      color: #555;
    }
    .popup-text {
      margin-left: 6px;
      color: #444;
    }
    .popup-price {
      font-weight: 700;
      color: #27ae60;
      font-size: 1.1em;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="zoom-info">
  Zoom: <span id="zoom-level">7</span> 
  <span id="markers-status">(Marcadores ocultos - Haz zoom para verlos)</span>
</div>

<button id="centrar-btn" title="Centrar en mi ubicación">
  <svg width="24" height="24" fill="#007bff" viewBox="0 0 24 24">
    <path d="M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm10 4a10 10 0 0 0-10-10v2a8 8 0 0 1 8 8h2zm-10 10a10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8v2zm-10-10a10 10 0 0 0 10 10v-2a8 8 0 0 1-8-8H2zm10-10A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8V2z"/>
  </svg>
</button>

<div id="formulario">
  <h3 style="margin-top: 0;">Añadir lugar</h3>
  <input type="text" id="titulo" placeholder="Título" required />
  <select id="categoria">
    <optgroup label="Comida">
      <option value="bar">Bar</option>
      <option value="restaurante">Restaurante</option>
      <option value="supermercado">Supermercado</option>
      <option value="cafeteria">Cafetería</option>
    </optgroup>
    <optgroup label="Ocio">
      <option value="discoteca">Discoteca</option>
      <option value="playa">Playa</option>
      <option value="turistico">Monumento / Sitio turístico</option>
      <option value="gimnasio">Gimnasio</option>
    </optgroup>
    <optgroup label="Servicios">
      <option value="copisteria">Copistería</option>
      <option value="oficina">Oficina</option>
      <option value="cajero">Cajero automático</option>
      <option value="correos">Oficina de correos</option>
      <option value="tienda">Tienda</option>
    </optgroup>
    <optgroup label="Transporte">
      <option value="tren">Estación de tren</option>
      <option value="bus">Estación de bus</option>
    </optgroup>
    <optgroup label="Salud">
      <option value="farmacia">Farmacia</option>
      <option value="centro_medico">Centro médico</option>
    </optgroup>
    <optgroup label="Educación">
      <option value="biblioteca">Biblioteca</option>
      <option value="facultad">Facultad</option>
      <option value="residencia">Residencia</option>
    </optgroup>
    <optgroup label="Otros">
      <option value="otro">Otro</option>
    </optgroup>
  </select>
  <input type="text" id="horario" placeholder="Horario (opcional)" />
  <textarea id="descripcion" rows="3" placeholder="Descripción (opcional)"></textarea>
  <input type="text" id="precio" placeholder="Precio (opcional)" />
  <button onclick="guardarLugar()">Guardar lugar</button>
  <button onclick="cerrarFormulario()">Cerrar</button>
</div>

<script>
  const supabaseClient = supabase.createClient(
    'https://lqwwqdyqoqltxpmlejxi.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxd3dxZHlxb3FsdHhwbWxlanhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MDM4OTYsImV4cCI6MjA2NDA3OTg5Nn0.63Eoa39OIjDUlxHCPLZ9aRH1GK6-WWB_MkFgsylBJWI'
  );

  // Variables de control de zoom y carga
  const ZOOM_MINIMO_MARCADORES = 10; // Zoom mínimo para mostrar marcadores
  let marcadoresVisibles = false;
  let datosLugares = []; // Cache de datos
  let marcadoresLayer = []; // Array para controlar marcadores

  let latSeleccionada = null;
  let lngSeleccionada = null;
  let marcadorTemp = null;
  const formulario = document.getElementById("formulario");

  function generarUUID() {
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }

  let usuarioId = localStorage.getItem("usuario_id");
  if (!usuarioId) {
    usuarioId = generarUUID();
    localStorage.setItem("usuario_id", usuarioId);
  }

  const map = L.map('map').setView([37.6, 14.0], 7);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 20
  }).addTo(map);

  let positionMarker = null;

  // Actualizar información de zoom en la interfaz
  function actualizarInfoZoom() {
    const zoomActual = map.getZoom();
    document.getElementById('zoom-level').textContent = zoomActual;
    
    const statusElement = document.getElementById('markers-status');
    if (zoomActual >= ZOOM_MINIMO_MARCADORES) {
      statusElement.textContent = `(${datosLugares.length} lugares visibles)`;
      statusElement.style.color = '#27ae60';
    } else {
      statusElement.textContent = '(Marcadores ocultos - Haz zoom para verlos)';
      statusElement.style.color = '#e74c3c';
    }
  }

  // Manejar cambios de zoom
  map.on('zoomend', function() {
    const zoomActual = map.getZoom();
    actualizarInfoZoom();

    if (zoomActual >= ZOOM_MINIMO_MARCADORES && !marcadoresVisibles) {
      // Zoom suficiente y marcadores no visibles -> cargar
      if (datosLugares.length === 0) {
        cargarLugares(); // Primera carga desde BD
      } else {
        mostrarMarcadores(); // Usar datos en cache
      }
    } else if (zoomActual < ZOOM_MINIMO_MARCADORES && marcadoresVisibles) {
      // Zoom insuficiente y marcadores visibles -> ocultar
      ocultarMarcadores();
    }
  });

  // Evento inicial para configurar el estado
  map.on('moveend', function() {
    actualizarInfoZoom();
  });

  function actualizarPosicion(lat, lng) {
    const blueDotIcon = L.divIcon({
      className: 'blue-dot',
      html: `<div style="
        width: 16px;
        height: 16px;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4), 0 2px 8px rgba(59, 130, 246, 0.2);
        animation: positionPulse 2s ease-in-out infinite;
      "></div>
      <style>
        @keyframes positionPulse {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.1); }
        }
      </style>`,
      iconSize: [16, 16],
      iconAnchor: [8, 8],
    });

    if (!positionMarker) {
      positionMarker = L.marker([lat, lng], { icon: blueDotIcon, interactive: false }).addTo(map);
    } else {
      positionMarker.setLatLng([lat, lng]);
    }
  }

  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        actualizarPosicion(latitude, longitude);

        map.flyTo([latitude, longitude], 15, { duration: 2 });
      },
      (error) => console.warn("Ubicación no disponible:", error.message),
      { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
    );
  }

  map.on('click', function (e) {
    // Solo permitir agregar lugares si el zoom es suficiente
    if (map.getZoom() < ZOOM_MINIMO_MARCADORES) {
      alert('Haz zoom para poder agregar lugares con precisión');
      return;
    }

    latSeleccionada = e.latlng.lat;
    lngSeleccionada = e.latlng.lng;

    if (marcadorTemp) map.removeLayer(marcadorTemp);

    marcadorTemp = L.circleMarker([latSeleccionada, lngSeleccionada], {
      radius: 8,
      color: '#007bff',
      fillColor: '#007bff',
      fillOpacity: 0.5
    }).addTo(map);

    const puntoPantalla = map.latLngToContainerPoint(e.latlng);
    formulario.style.left = `${puntoPantalla.x}px`;
    formulario.style.top = `${puntoPantalla.y}px`;
    formulario.style.display = "block";
  });

  async function guardarLugar() {
    const titulo = document.getElementById("titulo").value;
    const categoria = document.getElementById("categoria").value;
    const horario = document.getElementById("horario").value;
    const descripcion = document.getElementById("descripcion").value;
    const precio = document.getElementById("precio").value;

    if (!titulo || !categoria || latSeleccionada === null || lngSeleccionada === null) {
      alert("Faltan datos obligatorios.");
      return;
    }

    const datos = {
      titulo,
      categoria,
      horario,
      descripcion,
      precio,
      lat: latSeleccionada,
      lng: lngSeleccionada,
      usuario_id: usuarioId
    };

    const { data, error } = await supabaseClient.from('lugares').insert([datos]);

    if (error) {
      alert("Error al guardar lugar: " + error.message);
      return;
    }

    cerrarFormulario();
    // Recargar datos y actualizar marcadores si están visibles
    await cargarLugares();
  }

  function cerrarFormulario() {
    formulario.style.display = "none";
    document.getElementById("titulo").value = "";
    document.getElementById("categoria").value = "bar";
    document.getElementById("horario").value = "";
    document.getElementById("descripcion").value = "";
    document.getElementById("precio").value = "";

    if (marcadorTemp) {
      map.removeLayer(marcadorTemp);
      marcadorTemp = null;
    }
    latSeleccionada = null;
    lngSeleccionada = null;
  }

  // Función para devolver color según categoría
  function obtenerColorPorCategoria(categoria) {
    const colores = {
      bar: '#e74c3c',
      restaurante: '#e67e22',
      supermercado: '#f1c40f',
      cafeteria: '#d35400',
      discoteca: '#9b59b6',
      playa: '#3498db',
      turistico: '#2ecc71',
      gimnasio: '#16a085',
      copisteria: '#95a5a6',
      oficina: '#34495e',
      cajero: '#27ae60',
      correos: '#1abc9c',
      tienda: '#8e44ad',
      tren: '#c0392b',
      bus: '#7f8c8d',
      farmacia: '#2980b9',
      centro_medico: '#d35400',
      biblioteca: '#2c3e50',
      facultad: '#27ae60',
      residencia: '#16a085',
      otro: '#7f8c8d'
    };
    return colores[categoria] || '#34495e';
  }

  // Crear icono de marcador coloreado con diseño moderno
  function crearIconoColor(color) {
    return L.divIcon({
      className: '',
      html: `<div style="
        width: 20px;
        height: 20px;
        background: linear-gradient(135deg, ${color}, ${color}dd);
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 4px 12px ${color}60, 0 2px 4px ${color}40;
        transform: translateY(-2px);
        transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
      "></div>`,
      iconSize: [20, 20],
      iconAnchor: [10, 10],
    });
  }

  // Función para cargar los lugares desde Supabase
  async function cargarLugares() {
    try {
      const { data, error } = await supabaseClient.from('lugares').select();

      if (error) {
        console.error("Error cargando lugares:", error.message);
        return;
      }

      // Actualizar cache de datos
      datosLugares = data || [];
      
      // Solo mostrar marcadores si el zoom es suficiente
      if (map.getZoom() >= ZOOM_MINIMO_MARCADORES) {
        mostrarMarcadores();
      }
      
      actualizarInfoZoom();
    } catch (error) {
      console.error("Error en cargarLugares:", error);
    }
  }

  // Función para mostrar marcadores en el mapa
  function mostrarMarcadores() {
    // Limpiar marcadores existentes
    ocultarMarcadores();

    datosLugares.forEach(lugar => {
      const iconoColor = crearIconoColor(obtenerColorPorCategoria(lugar.categoria));
      const popupHTML = `
        <div class="popup-content">
          <div class="popup-title">${escapeHtml(lugar.titulo)}</div>
          <div class="popup-category">${escapeHtml(lugar.categoria.replace('_', ' '))}</div>
          ${lugar.horario ? `<div class="popup-field"><span class="popup-label">Horario:</span><span class="popup-text">${escapeHtml(lugar.horario)}</span></div>` : ''}
          ${lugar.descripcion ? `<div class="popup-field"><span class="popup-label">Descripción:</span><span class="popup-text">${escapeHtml(lugar.descripcion)}</span></div>` : ''}
          ${lugar.precio ? `<div class="popup-field"><span class="popup-price">Precio: ${escapeHtml(lugar.precio)}</span></div>` : ''}
        </div>`;

      const marcador = L.marker([lugar.lat, lugar.lng], { icon: iconoColor })
        .bindPopup(popupHTML);
      
      marcadoresLayer.push(marcador);
      marcador.addTo(map);
    });

    marcadoresVisibles = true;
    actualizarInfoZoom();
  }

  // Función para ocultar marcadores
  function ocultarMarcadores() {
    marcadoresLayer.forEach(marcador => {
      map.removeLayer(marcador);
    });
    marcadoresLayer = [];
    marcadoresVisibles = false;
    actualizarInfoZoom();
  }

  // Escapar texto para prevenir XSS
  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<>"']/g, function(m) {
      return ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m];
    });
  }

  document.getElementById("centrar-btn").addEventListener("click", () => {
    if (positionMarker) {
      map.flyTo(positionMarker.getLatLng(), 15, { duration: 2 });
    }
  });

  // Inicializar información de zoom
  actualizarInfoZoom();

</script>

</body>
</html>

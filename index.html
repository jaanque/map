<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Sicilia - Erasmus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html, body { margin: 0; height: 100%; }
    #map { width: 100%; height: 100vh; }

    .pulse-circle {
      border: 2px solid #007bff;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: pulse 3s ease-in-out infinite;
      position: absolute;
      top: 50%;
      left: 50%;
      margin-left: -12px;
      margin-top: -12px;
      pointer-events: none;
    }

    @keyframes pulse {
      0% { opacity: 0.2; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.6); }
      100% { opacity: 0.2; transform: scale(1); }
    }

    #formulario {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      padding: 16px;
      border-radius: 14px;
      width: 300px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
      z-index: 1000;
      animation: abrirFormulario 0.4s ease-out;
    }

    @keyframes abrirFormulario {
      0% { opacity: 0; transform: scale(0.7); }
      100% { opacity: 1; transform: scale(1); }
    }

    #centrar-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 999;
      background: white;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    #centrar-btn:hover {
      transform: scale(1.1);
    }
  </style>
</head>
<body>

<div id="map"></div>

<button id="centrar-btn" title="Centrar en mi ubicación">
  <svg width="24" height="24" fill="#007bff" viewBox="0 0 24 24">
    <path d="M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm10 4a10 10 0 0 0-10-10v2a8 8 0 0 1 8 8h2zm-10 10a10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8v2zm-10-10a10 10 0 0 0 10 10v-2a8 8 0 0 1-8-8H2zm10-10A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8V2z"/>
  </svg>
</button>

<div id="formulario">
  <h3 style="margin-top: 0;">Añadir lugar</h3>
  <input type="text" id="titulo" placeholder="Título" required />
  <select id="categoria">
    <optgroup label="Comida">
      <option value="bar">Bar</option>
      <option value="restaurante">Restaurante</option>
      <option value="supermercado">Supermercado</option>
      <option value="cafeteria">Cafetería</option>
    </optgroup>
    <optgroup label="Ocio">
      <option value="discoteca">Discoteca</option>
      <option value="playa">Playa</option>
      <option value="turistico">Monumento / Sitio turístico</option>
      <option value="gimnasio">Gimnasio</option>
    </optgroup>
    <optgroup label="Servicios">
      <option value="copisteria">Copistería</option>
      <option value="oficina">Oficina</option>
      <option value="cajero">Cajero automático</option>
      <option value="correos">Oficina de correos</option>
      <option value="tienda">Tienda</option>
    </optgroup>
    <optgroup label="Transporte">
      <option value="tren">Estación de tren</option>
      <option value="bus">Estación de bus</option>
    </optgroup>
    <optgroup label="Salud">
      <option value="farmacia">Farmacia</option>
      <option value="centro_medico">Centro médico</option>
    </optgroup>
    <optgroup label="Educación">
      <option value="biblioteca">Biblioteca</option>
      <option value="facultad">Facultad</option>
      <option value="residencia">Residencia</option>
    </optgroup>
    <optgroup label="Otros">
      <option value="otro">Otro</option>
    </optgroup>
  </select>
  <input type="text" id="horario" placeholder="Horario (opcional)" />
  <textarea id="descripcion" rows="3" placeholder="Descripción (opcional)"></textarea>
  <input type="text" id="precio" placeholder="Precio (opcional)" />
  <button onclick="guardarLugar()">Guardar lugar</button>
  <button onclick="cerrarFormulario()">Cerrar</button>
</div>

<script>
  const supabaseClient = supabase.createClient(
    'https://lqwwqdyqoqltxpmlejxi.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxd3dxZHlxb3FsdHhwbWxlanhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MDM4OTYsImV4cCI6MjA2NDA3OTg5Nn0.63Eoa39OIjDUlxHCPLZ9aRH1GK6-WWB_MkFgsylBJWI'
  );

  let latSeleccionada = null;
  let lngSeleccionada = null;
  let marcadorTemp = null;
  const formulario = document.getElementById("formulario");

  function generarUUID() {
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }

  let usuarioId = localStorage.getItem("usuario_id");
  if (!usuarioId) {
    usuarioId = generarUUID();
    localStorage.setItem("usuario_id", usuarioId);
  }

  const map = L.map('map').setView([37.6, 14.0], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let positionMarker = null;
  let pulseMarker = null;

  function actualizarPosicion(lat, lng) {
    const blueDotIcon = L.divIcon({
      className: 'blue-dot',
      html: `<div style="width: 12px;height: 12px;background: #007bff;border-radius: 50%;border: 2px solid white;box-shadow: 0 0 3px #007bffaa;"></div>`,
      iconSize: [16, 16],
      iconAnchor: [8, 8],
    });

    const pulseIcon = L.divIcon({ className: 'pulse-circle', html: '', iconSize: [24, 24], iconAnchor: [12, 12] });

    if (!positionMarker) {
      pulseMarker = L.marker([lat, lng], { icon: pulseIcon, interactive: false }).addTo(map);
      positionMarker = L.marker([lat, lng], { icon: blueDotIcon, interactive: false }).addTo(map);
    } else {
      positionMarker.setLatLng([lat, lng]);
      pulseMarker.setLatLng([lat, lng]);
    }
  }

  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        actualizarPosicion(latitude, longitude);
        map.flyTo([latitude, longitude], 15, { duration: 2 });
      },
      (error) => console.warn("Ubicación no disponible:", error.message),
      { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
    );
  }

  map.on('click', function (e) {
    latSeleccionada = e.latlng.lat;
    lngSeleccionada = e.latlng.lng;

    if (marcadorTemp) map.removeLayer(marcadorTemp);

    marcadorTemp = L.circleMarker([latSeleccionada, lngSeleccionada], {
      radius: 8,
      color: '#007bff',
      fillColor: '#007bff',
      fillOpacity: 0.5
    }).addTo(map);

    const puntoPantalla = map.latLngToContainerPoint(e.latlng);
    formulario.style.left = `${puntoPantalla.x}px`;
    formulario.style.top = `${puntoPantalla.y}px`;
    formulario.style.display = "block";
  });

  async function guardarLugar() {
    const titulo = document.getElementById("titulo").value;
    const categoria = document.getElementById("categoria").value;
    const horario = document.getElementById("horario").value;
    const descripcion = document.getElementById("descripcion").value;
    const precio = document.getElementById("precio").value;

    if (!titulo || !categoria || latSeleccionada === null || lngSeleccionada === null) {
      alert("Faltan datos obligatorios.");
      return;
    }

    const datos = {
      titulo,
      categoria,
      horario,
      descripcion,
      precio,
      lat: latSeleccionada,
      lng: lngSeleccionada,
      usuario_id: usuarioId,
    };

    const { data, error } = await supabaseClient.from('lugares').insert([datos]);

    if (error) {
      console.error("Error al guardar en Supabase:", error.message);
      alert("Error al guardar el lugar.");
    } else {
      cerrarFormulario();
      cargarLugares();
    }
  }

  function cerrarFormulario() {
    formulario.style.display = "none";
    document.getElementById("titulo").value = "";
    document.getElementById("horario").value = "";
    document.getElementById("descripcion").value = "";
    document.getElementById("precio").value = "";

    if (marcadorTemp) {
      map.removeLayer(marcadorTemp);
      marcadorTemp = null;
    }
  }

  formulario.addEventListener("click", (e) => e.stopPropagation());

  // FUNCIONALIDAD NUEVA: cargar lugares desde Supabase
  async function cargarLugares() {
    const { data, error } = await supabaseClient.from("lugares").select("*");

    if (error) {
      console.error("Error al cargar lugares:", error.message);
      return;
    }

    data.forEach((lugar) => {
      const marker = L.marker([lugar.lat, lugar.lng]).addTo(map);

      const contenidoPopup = `
        <strong>${lugar.titulo}</strong><br>
        Categoría: ${lugar.categoria}<br>
        ${lugar.descripcion ? `<em>${lugar.descripcion}</em><br>` : ''}
        ${lugar.precio ? `💶 Precio: ${lugar.precio}<br>` : ''}
        ${lugar.horario ? `🕒 Horario: ${lugar.horario}<br>` : ''}
      `;

      marker.bindPopup(contenidoPopup);
    });
  }

  // Llama a la función al inicio
  cargarLugares();
</script>

</body>
</html>
